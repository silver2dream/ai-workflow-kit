name: frontend-ci

on:
  pull_request:
    branches: [ "feat/example", "main" ]
  push:
    branches: [ "feat/example" ]

jobs:
  sanity:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (with LFS)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Basic Unity project structure checks
        shell: bash
        run: |
          set -euo pipefail

          echo "== Check Packages files =="
          test -f Packages/manifest.json
          echo "OK: Packages/manifest.json exists"
          if [ -f Packages/packages-lock.json ]; then
            echo "OK: Packages/packages-lock.json exists"
          else
            echo "WARN: Packages/packages-lock.json missing (not fatal)"
          fi

          echo "== Validate JSON syntax (manifest/lock) =="
          python - <<'PY'
          import json, pathlib, sys
          files = ["Packages/manifest.json", "Packages/packages-lock.json"]
          for f in files:
            p = pathlib.Path(f)
            if not p.exists():
              print(f"skip: {f} (missing)")
              continue
            try:
              json.loads(p.read_text(encoding="utf-8"))
              print(f"ok: {f} json valid")
            except Exception as e:
              print(f"ERROR: {f} invalid json: {e}")
              sys.exit(2)
          PY

          echo "== Check Assets folder =="
          test -d Assets
          echo "OK: Assets exists"

      - name: Basic .meta presence check
        shell: bash
        run: |
          set -euo pipefail
          count_files=$(find Assets -type f ! -name "*.meta" | wc -l | tr -d ' ')
          count_meta=$(find Assets -type f -name "*.meta" | wc -l | tr -d ' ')
          echo "Assets non-meta files: $count_files"
          echo "Assets meta files:     $count_meta"

          if [ "$count_files" -gt 0 ] && [ "$count_meta" -eq 0 ]; then
            echo "ERROR: Assets has files but no .meta files found."
            exit 3
          fi
          echo "OK: meta presence sanity check passed"

      - name: Ensure no huge files
        shell: bash
        run: |
          set -euo pipefail
          big=$(find . -type f -size +200M -not -path "./.git/*" | head -n 1 || true)
          if [ -n "$big" ]; then
            echo "ERROR: Found very large file: $big"
            exit 4
          fi
          echo "OK: no huge files detected"
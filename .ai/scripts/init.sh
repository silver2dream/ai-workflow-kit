#!/usr/bin/env bash
set -euo pipefail

# ============================================================================
# init.sh - ???撠???AI Workflow
# ============================================================================
# ?冽?:
#   bash .ai/scripts/init.sh
# ============================================================================

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
AI_ROOT="$(dirname "$SCRIPT_DIR")"
MONO_ROOT="$(dirname "$AI_ROOT")"

echo "????????????????????????????????????????????????????????????????
echo "??             AI Workflow Kit - ????                      ??
echo "????????????????????????????????????????????????????????????????
echo ""

# 瑼Ｘ?蔭?辣
CONFIG_FILE="$AI_ROOT/config/workflow.yaml"
if [[ ! -f "$CONFIG_FILE" ]]; then
  echo "[init] ?萄遣?身?蔭?辣..."
  mkdir -p "$AI_ROOT/config"
  cat > "$CONFIG_FILE" <<'YAML'
# AI Workflow Kit Configuration
version: "1.0"

project:
  name: "my-project"
  description: "My Project"
  type: "single-repo"  # monorepo | single-repo

repos:
  - name: root
    path: .
    type: root
    language: node  # go | node | python | unity | etc.
    rules:
      - git-workflow
    verify:
      build: "npm run build"
      test: "npm test"

git:
  integration_branch: "develop"
  release_branch: "main"
  commit_format: "[type] subject"

specs:
  base_path: ".ai/specs"
  active: []

tasks:
  format:
    uncompleted: "- [ ]"
    completed: "- [x]"
  source_priority:
    - audit
    - specs

audit:
  checks:
    - dirty-worktree

notifications:
  system_notify: true
YAML
  echo "[init] ?蔭?辣撌脣撱? $CONFIG_FILE"
  echo "[init] 隢楊頛舫?蝵格?隞嗅???瑁?甇方??
  exit 0
fi

# ?萄遣敹??桅?
echo "[init] ?萄遣?桅?蝯?..."
mkdir -p "$AI_ROOT/state"
mkdir -p "$AI_ROOT/results"
mkdir -p "$AI_ROOT/runs"
mkdir -p "$AI_ROOT/exe-logs"
mkdir -p "$AI_ROOT/specs"

# ?萄遣 .claude 蝚西????嚗???摮嚗?CLAUDE_DIR="$MONO_ROOT/.claude"
if [[ ! -d "$CLAUDE_DIR" ]]; then
  echo "[init] ?萄遣 .claude ?桅?..."
  mkdir -p "$CLAUDE_DIR"
fi

# 瘜冽?嚗indows 銝泵????閬恣?甈?嚗ㄐ?刻?鋆賭誨??if [[ ! -d "$CLAUDE_DIR/commands" ]]; then
  echo "[init] 銴ˊ commands ??.claude/..."
  cp -r "$AI_ROOT/commands" "$CLAUDE_DIR/"
fi

if [[ ! -d "$CLAUDE_DIR/rules" ]]; then
  echo "[init] 銴ˊ rules ??.claude/..."
  cp -r "$AI_ROOT/rules" "$CLAUDE_DIR/"
fi

# ?? CLAUDE.md ??AGENTS.md
echo "[init] ?? Agent ??..."
bash "$AI_ROOT/scripts/generate.sh"

# ?萄遣 .gitignore 璇
GITIGNORE="$MONO_ROOT/.gitignore"
if [[ -f "$GITIGNORE" ]]; then
  if ! grep -q ".ai/state/" "$GITIGNORE" 2>/dev/null; then
    echo "[init] ?湔 .gitignore..."
    echo "" >> "$GITIGNORE"
    echo "# AI Workflow" >> "$GITIGNORE"
    echo ".ai/state/" >> "$GITIGNORE"
    echo ".ai/results/" >> "$GITIGNORE"
    echo ".ai/runs/" >> "$GITIGNORE"
    echo ".ai/exe-logs/" >> "$GITIGNORE"
    echo ".worktrees/" >> "$GITIGNORE"
  fi
fi

echo ""
echo "????????????????????????????????????????????????????????????????
echo "??             ??????                                   ??
echo "????????????????????????????????????????????????????????????????
echo "??                                                            ??
echo "?? 銝?甇?                                                    ??
echo "?? 1. 蝺刻摩 .ai/config/workflow.yaml ?蔭撠?                  ??
echo "?? 2. ?瑁? bash .ai/scripts/generate.sh ?????          ??
echo "?? 3. ?瑁? bash .ai/scripts/kickoff.sh ??撌乩?瘚?            ??
echo "??                                                            ??
echo "????????????????????????????????????????????????????????????????

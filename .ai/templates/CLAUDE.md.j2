# CLAUDE.md (Principal + Worker Orchestration)

This file provides guidance for Claude Code (Principal) when working with this project.

## Project Overview

**Name:** {{ project.name }}
**Type:** {{ project.type }}
**Repos:** {% for repo in repos %}{{ repo.name }}{% if not loop.last %}, {% endif %}{% endfor %}

## Rule Routing (IMPORTANT)

Before coding, ALWAYS identify which area the task touches, then apply the corresponding rules:

### Kit Core Rules (ALWAYS)
{% for rule in rules.kit | default(['git-workflow']) %}
- `.ai/rules/_kit/{{ rule }}.md`{% if rule == 'git-workflow' %} (commit format + PR base){% endif %}

{% endfor %}

{% set custom_rules = rules.custom | default([]) %}
{% if custom_rules %}
### Project-Specific Rules (enabled)
{% for rule in custom_rules %}
- `.ai/rules/{{ rule }}.md`
{% endfor %}
{% else %}
### Optional Example Rules (not enabled by default)
If you want stricter, tech-specific rules, copy from `.ai/rules/_examples/` into `.ai/rules/`, then add them under `rules.custom` in `.ai/config/workflow.yaml`.
{% endif %}

---

## Principal Autonomous Flow (MUST FOLLOW)

### Phase A — Project Audit (BEFORE tasks)

Run:
```bash
bash .ai/scripts/scan_repo.sh
bash .ai/scripts/audit_project.sh
```

Read output:
- `.ai/state/repo_scan.json`
- `.ai/state/audit.json`

Decision rule:
- If audit has any **P0/P1** findings: create fix tickets FIRST.
- Only if audit has no P0/P1 blockers, proceed to Phase B.

### Phase B — Task Selection

Read active specs:
{% for spec in specs.active %}
- `{{ specs.base_path }}/{{ spec }}/tasks.md`
{% endfor %}

Find uncompleted tasks (`{{ tasks.format.uncompleted }}`) and create GitHub Issues.

### Phase C — Execution (Worker / Codex)

Worker takes one ticket and runs:
```bash
bash .ai/scripts/run_issue_codex.sh <id> <ticket_file> <repo>
```

Worker MUST:
1. Implement within scope
2. Verify (commands listed in ticket)
3. Commit using `{{ git.commit_format }}` (lowercase)
4. Push branch
5. Create PR (base: `{{ git.integration_branch }}`, release: `{{ git.release_branch }}`)
6. Write `.ai/results/issue-<id>.json` with PR URL

### Phase D — Review

Review PR using:
```bash
gh pr diff <PR_NUMBER>
```

Check:
- Commit format: `{{ git.commit_format }}`
- PR base: `{{ git.integration_branch }}`
- Changes within scope
- Architecture rules compliance

---

## Ticket Format (STRICT TEMPLATE)

```markdown
# [type] short title

- Repo: {% for repo in repos %}{{ repo.name }}{% if not loop.last %} | {% endif %}{% endfor %}
- Severity: P0 | P1 | P2
- Source: audit:<finding-id> | tasks.md #<n>
- Release: false

## Objective
(what to achieve)

## Scope
(what to change)

## Non-goals
(what NOT to change)

## Constraints
- obey AGENTS.md
- obey `.ai/rules/_kit/git-workflow.md`
- obey enabled project rules in `.ai/rules/` (if any)

## Plan
(steps)

## Verification
{% for repo in repos %}
- {{ repo.name }}: `{{ repo.verify.build }}` and `{{ repo.verify.test }}`
{% endfor %}

## Acceptance Criteria
- [ ] ...
```

---

## REPO TYPE SUPPORT

AWK supports three repository types configured in `.ai/config/workflow.yaml`:

| Type | Description | Use Case |
|------|-------------|----------|
| `root` | Single repository | Standalone projects |
| `directory` | Subdirectory in monorepo | Monorepo with shared .git |
| `submodule` | Git submodule | Monorepo with independent repos |

### Type-Specific Behavior

- **root**: All operations run from repo root. Path must be `./`.
- **directory**: Operations run from worktree root, changes scoped to subdirectory.
- **submodule**: Commits/pushes happen in submodule first, then parent updates reference.

### Submodule Constraints
- Changes must stay within submodule boundary (unless `allow_parent_changes: true`)
- PRs target parent repo, not submodule remote
- Rollback reverts both submodule and parent commits

---

## Quick Reference

### Start Work
```bash
bash .ai/scripts/kickoff.sh
```

### Check Status
```bash
bash .ai/scripts/stats.sh
```

### Stop Work
```bash
touch .ai/state/STOP
```

## File Locations

| What | Where |
|------|-------|
| Config | `.ai/config/workflow.yaml` |
| Scripts | `.ai/scripts/` |
| Rules | `.ai/rules/` |
| Commands | `.ai/commands/` |
| Specs | `{{ specs.base_path }}/` |
| Results | `.ai/results/` |

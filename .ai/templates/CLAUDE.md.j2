# CLAUDE.md (Principal + Worker Orchestration)

This file provides guidance for Claude Code (Principal) when working with this project.

## Project Overview

**Name:** {{ project.name }}
**Type:** {{ project.type }}
**Repos:** {% for repo in repos %}{{ repo.name }}{% if not loop.last %}, {% endif %}{% endfor %}

## Rule Routing (IMPORTANT)

Before coding, ALWAYS identify which area the task touches, then apply the corresponding rules:

{% for repo in repos %}
### {{ repo.name | capitalize }} work
- Follow: `.ai/rules/{{ repo.rules | join('.md`, `.ai/rules/') }}.md`
{% endfor %}

### Git & PR workflow (ALWAYS)
- Follow: `.ai/rules/git-workflow.md` (commit format + PR base)

---

## Principal Autonomous Flow (MUST FOLLOW)

### Phase A — Project Audit (BEFORE tasks)

Run:
```bash
bash .ai/scripts/scan_repo.sh
bash .ai/scripts/audit_project.sh
```

Read output:
- `.ai/state/repo_scan.json`
- `.ai/state/audit.json`

Decision rule:
- If audit has any **P0/P1** findings: create fix tickets FIRST.
- Only if audit has no P0/P1 blockers, proceed to Phase B.

### Phase B — Task Selection

Read active specs:
{% for spec in specs.active %}
- `{{ specs.base_path }}/{{ spec }}/tasks.md`
{% endfor %}

Find uncompleted tasks (`{{ tasks.format.uncompleted }}`) and create GitHub Issues.

### Phase C — Execution (Worker / Codex)

Worker takes one ticket and runs:
```bash
bash .ai/scripts/run_issue_codex.sh <id> <ticket_file> <repo>
```

Worker MUST:
1. Implement within scope
2. Verify (commands listed in ticket)
3. Commit using `{{ git.commit_format }}` (lowercase)
4. Push branch
5. Create PR (base: `{{ git.integration_branch }}`, release: `{{ git.release_branch }}`)
6. Write `.ai/results/issue-<id>.json` with PR URL

### Phase D — Review

Review PR using:
```bash
gh pr diff <PR_NUMBER>
```

Check:
- Commit format: `{{ git.commit_format }}`
- PR base: `{{ git.integration_branch }}`
- Changes within scope
- Architecture rules compliance

---

## Ticket Format (STRICT TEMPLATE)

```markdown
# [type] short title

- Repo: {% for repo in repos %}{{ repo.name }}{% if not loop.last %} | {% endif %}{% endfor %}
- Severity: P0 | P1 | P2
- Source: audit:<finding-id> | tasks.md #<n>
- Release: false

## Objective
(what to achieve)

## Scope
(what to change)

## Non-goals
(what NOT to change)

## Constraints
- obey AGENTS.md
- obey `.ai/rules/git-workflow.md`
- obey the routed architecture rules

## Plan
(steps)

## Verification
{% for repo in repos %}
- {{ repo.name }}: `{{ repo.verify.build }}` and `{{ repo.verify.test }}`
{% endfor %}

## Acceptance Criteria
- [ ] ...
```

---

## Quick Reference

### Start Work
```bash
bash .ai/scripts/kickoff.sh
```

### Check Status
```bash
bash .ai/scripts/stats.sh
```

### Stop Work
```bash
touch .ai/state/STOP
```

## File Locations

| What | Where |
|------|-------|
| Config | `.ai/config/workflow.yaml` |
| Scripts | `.ai/scripts/` |
| Rules | `.ai/rules/` |
| Commands | `.ai/commands/` |
| Specs | `{{ specs.base_path }}/` |
| Results | `.ai/results/` |
